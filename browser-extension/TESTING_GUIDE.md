# 右键菜单商品分析功能测试指南

## 问题修复总结

已修复以下问题：
1. ✅ 右键菜单点击后没有反应
2. ✅ 侧边栏未自动打开
3. ✅ 商品信息提取失败
4. ✅ 分析功能未自动触发

## 修复内容

### 1. Background Script (background.js)
- ✅ 增强了右键菜单点击处理
- ✅ 自动打开侧边栏
- ✅ 等待侧边栏加载完成
- ✅ 触发商品信息提取和分析
- ✅ 添加了详细的日志输出

### 2. Content Script (content.js)
- ✅ 改进了商品信息提取逻辑
- ✅ 添加了重试机制
- ✅ 添加了页面通知提示
- ✅ 自动保存商品信息到storage
- ✅ 通知侧边栏更新

### 3. Sidepanel (sidepanel.js)
- ✅ 监听来自background的分析请求
- ✅ 自动切换到分析视图
- ✅ 自动触发分析按钮
- ✅ 使用storage作为消息中介
- ✅ 改进了商品信息加载逻辑

## 测试步骤

### 步骤 1: 重新加载扩展
1. 打开 Chrome 浏览器
2. 访问 `chrome://extensions/`
3. 找到"智能购物助手 LLM Agent"扩展
4. 点击刷新按钮 🔄 重新加载扩展

### 步骤 2: 访问商品页面
1. 访问任意购物网站的商品详情页：
   - 京东：https://item.jd.com/xxxxx.html
   - 淘宝：https://item.taobao.com/item.htm?id=xxxxx
   - 天猫：https://detail.tmall.com/item.htm?id=xxxxx
   - 拼多多：https://mobile.yangkeduo.com/goods.html?goods_id=xxxxx

### 步骤 3: 使用右键菜单
1. 在商品页面上右键点击
2. 选择"分析当前商品"菜单项
3. 应该看到：
   - ✅ 侧边栏自动打开
   - ✅ 自动切换到"分析"标签
   - ✅ 自动开始分析商品
   - ✅ 页面右上角显示"分析完成！请查看侧边栏"通知

### 步骤 4: 查看分析结果
1. 在侧边栏的"分析"视图中
2. 查看以下内容：
   - 📊 综合分析（LLM生成的分析报告）
   - 💡 购买建议（立即购买/等待降价/谨慎考虑）
   - 💰 价格分析（当前价格、平台信息）
   - ⚠️ 风险评估（风险等级、风险数量）

## 调试技巧

### 查看日志
1. 打开开发者工具（F12）
2. 查看以下位置的日志：
   - **Background Service Worker**: 
     - 点击扩展的"service worker"链接
     - 查看控制台日志
   - **Content Script**:
     - 在商品页面的控制台查看
   - **Sidepanel**:
     - 右键点击侧边栏 -> 检查
     - 查看侧边栏的控制台

### 常见问题排查

#### 问题 1: 右键菜单未出现
- **检查**: manifest.json 中是否有 `"contextMenus"` 权限
- **解决**: 确保已重新加载扩展

#### 问题 2: 点击后没有反应
- **检查**: Background Service Worker 的控制台是否有错误
- **检查**: 商品页面是否在支持的域名列表中
- **解决**: 查看日志，检查错误信息

#### 问题 3: 侧边栏未打开
- **检查**: manifest.json 中是否有 `"sidePanel"` 权限
- **检查**: sidepanel.html 文件是否存在
- **解决**: 确保文件路径正确

#### 问题 4: 商品信息未提取
- **检查**: Content Script 是否正确注入
- **检查**: 商品页面DOM结构是否匹配选择器
- **解决**: 查看content.js的控制台日志

#### 问题 5: 分析功能未触发
- **检查**: 侧边栏是否收到分析请求消息
- **检查**: 分析按钮是否存在
- **解决**: 查看sidepanel.js的控制台日志

## 预期行为

当右键点击"分析当前商品"后，应该：

1. **立即**: 侧边栏自动打开
2. **1秒内**: 商品信息提取完成
3. **1-2秒**: 自动切换到"分析"视图
4. **2-5秒**: 分析按钮自动点击
5. **5-10秒**: 显示分析结果
6. **同时**: 页面显示"分析完成！"通知

## 如果仍然无法工作

1. 检查后端服务是否运行：访问 http://localhost:8000/health
2. 检查浏览器控制台的所有错误信息
3. 尝试手动点击侧边栏的"分析商品"按钮
4. 检查网络请求是否成功发送到后端

## 手动测试方法

如果右键菜单不工作，可以手动测试：

1. 打开侧边栏（点击扩展图标或使用快捷键 Ctrl+Shift+Y）
2. 切换到"分析"标签
3. 点击"分析商品"按钮
4. 应该能看到分析结果

